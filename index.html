<!doctype html>
<html lang="lt">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Žemėlapiai pagal metus</title>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

  <style>
    :root { --gap: 16px; }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #f6f7f9;
      color: #111;
    }

    /* Kairėje – žemėlapis */
    .map-area {
      position: fixed;
      left: var(--gap);
      top: var(--gap);
      right: 260px;
      bottom: var(--gap);
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      overflow: hidden;
    }

    #map { width: 100%; height: 100%; }

    /* Dešinėje viršuje – meniu */
    .panel {
      position: fixed;
      top: var(--gap);
      right: var(--gap);
      width: 230px;
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 12px;
      padding: 14px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.06);
    }

    .panel h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }

    select {
      width: 100%;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      background: #fff;
      font-size: 14px;
      outline: none;
    }

    .note {
      margin-top: 10px;
      font-size: 12px;
      color: #444;
      line-height: 1.35;
    }

    .badge {
      display: inline-block;
      margin-top: 10px;
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #eef2ff;
      border: 1px solid #d9ddff;
      color: #223;
      word-break: break-word;
    }

    @media (max-width: 820px) {
      .map-area { right: var(--gap); bottom: 190px; }
      .panel { width: auto; left: var(--gap); right: var(--gap); top: auto; bottom: var(--gap); }
    }
  </style>
</head>

<body>
  <div class="map-area">
    <div id="map"></div>
  </div>

  <div class="panel">
    <h3>Metai</h3>
    <select id="yearSelect" aria-label="Pasirink metus">
      <option value="2022" selected>2022</option>
      <option value="2023">2023</option>
      <option value="2024">2024</option>
      <option value="2025">2025</option>
      <option value="2026">2026</option>
    </select>

    <div class="badge" id="status">Rodomas: 2022</div>
    <div class="badge" id="clickXY">Paskutinis paspaudimas: -</div>

    <div class="note">
      JPG kelias: <b>assets/2022.jpg</b> ir t.t.<br>
      GeoJSON kelias: <b>data/cities_2022.geojson</b> ir t.t.<br><br>
      Koordinates gausi paspaudęs ant žemėlapio (x,y).
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <script>
    const yearSelect = document.getElementById("yearSelect");
    const status = document.getElementById("status");
    const clickXY = document.getElementById("clickXY");

    // 1) Pikselinė koordinačių sistema (JPG paveikslėliui)
    const map = L.map('map', {
      crs: L.CRS.Simple,
      minZoom: -2,
      maxZoom: 4,
      zoomControl: true
    });

    let overlay = null;
    let citiesLayer = null;

    // 2) Paspaudimo koordinačių rodymas (čia tu „susirasi“ Vilnių ir Kauną)
    map.on('click', (e) => {
      const x = Math.round(e.latlng.lng); // x (į dešinę)
      const y = Math.round(e.latlng.lat); // y (žemyn)
      clickXY.textContent = `Paskutinis paspaudimas: x=${x}, y=${y}`;
      console.log(`CLICK x=${x}, y=${y}`);
    });

    async function loadYear(year) {
      status.textContent = `Rodomas: ${year}`;

      // 3) Užkraunam paveikslą ir sužinom jo dydį (pikseliais)
      const imgUrl = `assets/${year}.jpg`;
      const img = new Image();
      img.src = imgUrl;
      await img.decode();

      const w = img.naturalWidth;
      const h = img.naturalHeight;

      // bounds Leaflet'e yra [[y1,x1],[y2,x2]]
      const bounds = [[0, 0], [h, w]];

      // 4) Pakeičiam JPG overlay
      if (overlay) map.removeLayer(overlay);
      overlay = L.imageOverlay(imgUrl, bounds).addTo(map);
      map.fitBounds(bounds);

      // 5) Užkraunam miestus iš GeoJSON (jei failas egzistuoja)
      const geoUrl = `data/cities_${year}.geojson`;

      if (citiesLayer) map.removeLayer(citiesLayer);

      try {
        const res = await fetch(geoUrl);
        if (!res.ok) throw new Error(`GeoJSON nerastas: ${geoUrl}`);
        const geo = await res.json();

        // GeoJSON Point coordinates: [x,y]
        // Leaflet marker: [y,x]
        citiesLayer = L.geoJSON(geo, {
          pointToLayer: (feature) => {
            const x = feature.geometry.coordinates[0];
            const y = feature.geometry.coordinates[1];
            return L.circleMarker([y, x], { radius: 7 });
          },
          onEachFeature: (feature, layer) => {
            const p = feature.properties || {};
            const name = p.name ?? "Miestas";
            const pop = p.population ?? "n/a";
            layer.bindPopup(`<b>${name}</b><br>Gyventojų sk.: ${pop}`);
          }
        }).addTo(map);
      } catch (err) {
        console.warn(err.message);
      }
    }

    yearSelect.addEventListener("change", () => loadYear(yearSelect.value));

    // start
    loadYear("2022");
  </script>
</body>
</html>
